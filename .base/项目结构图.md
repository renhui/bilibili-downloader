# 项目结构可视化

## 目录树

```
bilibili-downloader/
│
├── 📄 package.json              # 项目配置和依赖
├── 📄 README.md                 # 项目说明
├── 📄 LICENSE                   # GPL-3.0 许可证
├── 📄 renovate.json             # 依赖更新配置
├── 🖼️ screenshot.png            # 应用截图
│
└── 📁 app/                      # 应用主目录
    │
    ├── 📄 main.js               # ⭐ Electron 主进程入口
    ├── 📄 panel.html            # ⭐ 主界面 HTML
    ├── 📄 style.css             # 样式文件
    ├── 🖼️ bg.png                # 背景图片
    │
    ├── 📁 js/                   # JavaScript 业务逻辑
    │   │
    │   ├── 📄 panel.js          # ⭐ 面板控制逻辑
    │   ├── 📄 downloader.js     # ⭐ 下载核心模块
    │   ├── 📄 danmaku.js        # 弹幕处理模块
    │   ├── 📄 merge.js          # 音视频合并模块
    │   │
    │   └── 📁 login/            # 登录模块
    │       ├── 📄 login.js      # ⭐ 登录服务主类
    │       ├── 📄 login-qr.js   # 二维码登录
    │       └── 📄 login-helper.js  # 登录辅助工具
    │
    └── 📁 cdn/                  # 第三方 CDN 库
        ├── 📄 ass.js            # ASS 字幕生成库
        └── 📄 crc32.js          # CRC32 哈希计算库
```

⭐ = 核心文件

## 模块依赖关系

```
┌─────────────────────────────────────────┐
│         Electron 主进程                  │
│         (main.js)                        │
│  - 窗口管理                              │
│  - IPC 通信                              │
│  - 系统对话框                            │
└──────────────┬──────────────────────────┘
               │ IPC
               │
┌──────────────▼──────────────────────────┐
│         渲染进程 (panel.html)            │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │  Panel (panel.js)                  │ │
│  │  - UI 控制                          │ │
│  │  - 用户交互                          │ │
│  └──┬─────────────────────────────────┘ │
│     │                                    │
│     ├──► Downloader (downloader.js)     │
│     │    - 视频信息获取                   │
│     │    - 下载管理                       │
│     │    └──► LoginHelper                │
│     │                                    │
│     ├──► Danmaku (danmaku.js)           │
│     │    - 弹幕获取/过滤                  │
│     │    └──► ass.js (ASS 转换)          │
│     │    └──► crc32.js (用户 ID 破解)    │
│     │                                    │
│     ├──► Merge (merge.js)               │
│     │    └──► fluent-ffmpeg             │
│     │                                    │
│     └──► LoginService (login.js)        │
│          ├──► LoginQR (login-qr.js)     │
│          └──► LoginHelper                │
│                                          │
└──────────────────────────────────────────┘
```

## 数据流向

### 视频下载流程

```
用户输入 URL
    │
    ▼
┌─────────────────┐
│  Panel.getVideoInfo()  │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│  Downloader.getPlayUrlWebPage()  │
│  - 请求网页                      │
│  - 解析 __INITIAL_STATE__        │
│  - 解析 __playinfo__             │
└────────┬──────────────────┘
         │
         ▼
┌─────────────────────────┐
│  提取视频信息            │
│  - aid, bvid, cid       │
│  - 视频元数据            │
│  - DASH 流信息          │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  Panel.getDownloadItems() │
│  - 显示可下载资源列表      │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  用户选择资源            │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  Panel.downloadChecked() │
│  - 并行下载视频/音频      │
│  - 显示进度              │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  下载完成                │
│  - 提示合并              │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  ffmpegMerge()          │
│  - 合并音视频            │
└─────────────────────────┘
```

### 登录流程

```
应用启动
    │
    ▼
┌─────────────────┐
│  LoginService.login()  │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│  LoginQR.getLoginUrl()  │
│  - 获取二维码 URL        │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  LoginQR.getLoginQRCodeFromUrl() │
│  - 生成二维码图片        │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  显示二维码              │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  LoginService.getLoginStatus() │
│  - 轮询登录状态 (1秒/次)  │
└────────┬────────────────┘
         │
         ├──► 86101: 未扫码 ──┐
         ├──► 86090: 已扫码未确认 ──┤ 继续轮询
         ├──► 86038: 过期 ──┘
         │
         ▼
┌─────────────────────────┐
│  0: 登录成功             │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  LoginHelper.saveLoginInfoCookies() │
│  - 解析 Cookie          │
│  - 保存到本地文件        │
└─────────────────────────┘
```

### 弹幕处理流程

```
获取视频信息后
    │
    ▼
┌─────────────────┐
│  getDanmaku()   │
│  - 请求弹幕 XML  │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│  解析 XML                │
│  - 提取弹幕数据          │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  显示弹幕列表            │
│  - 支持过滤              │
└────────┬────────────────┘
         │
         ├──► 查看/搜索
         ├──► 下载 XML
         └──► 下载 ASS
              │
              ▼
         ┌─────────────────┐
         │  使用 ass.js 转换 │
         └─────────────────┘
```

## 文件职责矩阵

| 功能 | 主进程 | 渲染进程 | 说明 |
|------|--------|----------|------|
| 窗口管理 | ✅ | ❌ | main.js |
| IPC 通信 | ✅ | ✅ | 双向通信 |
| UI 渲染 | ❌ | ✅ | panel.html |
| 视频信息获取 | ❌ | ✅ | downloader.js |
| 文件下载 | ❌ | ✅ | downloader.js |
| 弹幕处理 | ❌ | ✅ | danmaku.js |
| 登录管理 | ❌ | ✅ | login/ |
| 音视频合并 | ❌ | ✅ | merge.js |
| 文件系统 | ✅ | ✅ | 主进程更安全 |
| 对话框 | ✅ | ❌ | 主进程 API |

## 关键文件行数统计

| 文件 | 行数 | 复杂度 |
|------|------|--------|
| main.js | 118 | 中等 |
| panel.html | 247 | 中等 |
| panel.js | 124 | 中等 |
| downloader.js | 231 | 高 |
| danmaku.js | 120 | 中等 |
| login.js | 115 | 中等 |
| login-qr.js | 49 | 低 |
| login-helper.js | 99 | 中等 |
| merge.js | 24 | 低 |

## 外部依赖关系

```
项目
│
├── Electron (运行时)
│   └── Chromium + Node.js
│
├── Bootstrap (UI)
│   └── CSS 框架
│
├── jQuery (DOM)
│   └── DOM 操作库
│
├── FFmpeg (视频处理)
│   ├── ffmpeg-static (二进制)
│   └── fluent-ffmpeg (封装)
│
├── HTTP 请求
│   └── node-fetch
│
├── Cookie 管理
│   └── tough-cookie
│
├── 二维码
│   └── qrcode
│
└── 工具库
    ├── progress-stream (进度)
    ├── filenamify (文件名)
    └── mime (MIME 类型)
```

## 代码组织原则

1. **模块化**: 每个功能独立成模块
2. **职责分离**: 主进程和渲染进程职责明确
3. **静态方法**: LoginQR 和 LoginHelper 使用静态方法
4. **类封装**: 核心功能使用类封装
5. **CDN 库**: 第三方库放在 cdn/ 目录

