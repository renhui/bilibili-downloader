# 技术栈和文件说明

## 快速参考

### 技术栈速查

| 技术 | 版本 | 用途 |
|------|------|------|
| Electron | 34.0.2 | 桌面应用框架 |
| Bootstrap | 5.3.3 | UI 框架 |
| jQuery | 3.7.1 | DOM 操作 |
| ffmpeg-static | 5.2.0 | FFmpeg 二进制 |
| fluent-ffmpeg | 2.1.3 | FFmpeg 封装 |
| node-fetch | 2.0.0 | HTTP 请求 |
| tough-cookie | 5.0.0 | Cookie 管理 |
| qrcode | 1.5.3 | 二维码生成 |
| progress-stream | 2.0.0 | 下载进度 |
| filenamify | 4.0.0 | 文件名清理 |
| mime | 3.0.0 | MIME 类型 |

## 文件功能说明

### 根目录文件

| 文件 | 说明 |
|------|------|
| `package.json` | 项目配置、依赖管理 |
| `README.md` | 项目说明文档 |
| `LICENSE` | GPL-3.0 许可证 |
| `screenshot.png` | 应用截图 |

### app/ 目录

#### 核心文件

| 文件 | 类型 | 功能 |
|------|------|------|
| `main.js` | 主进程 | Electron 主进程入口，窗口管理、IPC 通信 |
| `panel.html` | 界面 | 主界面 HTML，包含所有 UI 元素 |
| `style.css` | 样式 | 自定义样式 |
| `bg.png` | 资源 | 背景图片 |

#### js/ 目录 - 业务逻辑

| 文件 | 类/功能 | 说明 |
|------|---------|------|
| `panel.js` | Panel | 面板控制，UI 交互逻辑 |
| `downloader.js` | Downloader | 下载核心，视频信息获取、下载管理 |
| `danmaku.js` | - | 弹幕获取、过滤、转换、下载 |
| `merge.js` | - | FFmpeg 音视频合并 |

#### js/login/ 目录 - 登录模块

| 文件 | 类/功能 | 说明 |
|------|---------|------|
| `login.js` | LoginService | 登录服务主类，管理登录流程 |
| `login-qr.js` | LoginQR | 二维码生成和状态查询 |
| `login-helper.js` | LoginHelper | Cookie 解析和存储 |

#### cdn/ 目录 - 第三方库

| 文件 | 功能 |
|------|------|
| `ass.js` | ASS 字幕格式生成库 |
| `crc32.js` | CRC32 哈希计算，用于用户 ID 破解 |

## 核心类和方法

### Downloader 类

```javascript
// 主要属性
aid, bvid, pid, cid, videoData, playUrl, items, tasks

// 主要方法
getPlayUrlWebPage(url)      // 获取视频信息
getDownloadItems()          // 获取可下载资源
downloadByIndex(part, file, callback)  // 下载资源
parseVideo()                // 解析视频流
parseAudio()                // 解析音频流
```

### Panel 类

```javascript
// 主要方法
getVideoInfo()              // 获取视频信息
getDownloadItems()          // 显示下载选项
downloadChecked()           // 下载选中资源
```

### LoginService 类

```javascript
// 主要方法
login()                     // 启动登录流程
getLoginStatus(oauthKey)     // 轮询登录状态
```

### LoginQR 类（静态）

```javascript
getLoginUrl()               // 获取登录二维码 URL
getLoginStatus(qrcodeKey)   // 查询登录状态
getLoginQRCodeFromUrl(url)  // 生成二维码图片
```

### LoginHelper 类（静态）

```javascript
parseCookie(url)            // 解析 Cookie
saveLoginInfoCookies(url)   // 保存登录信息
getLoginInfoCookies()       // 读取登录信息
```

## IPC 通信

### 主进程 → 渲染进程

| 事件 | 说明 |
|------|------|
| `default-path` | 发送默认下载路径 |
| `download-path` | 返回选择的下载路径 |
| `context-menu-command` | 右键菜单命令 |

### 渲染进程 → 主进程

| 事件 | 说明 |
|------|------|
| `length` | 更新下载任务数量 |
| `show-context-menu` | 显示右键菜单 |
| `open-dialog` | 打开文件选择对话框 |
| `open-path` | 打开文件路径 |
| `open-external` | 打开外部链接 |
| `show-message` | 显示消息框 |

## API 端点

### Bilibili API

| 端点 | 用途 |
|------|------|
| `https://www.bilibili.com/video/*` | 视频页面（解析 HTML） |
| `https://comment.bilibili.com/{cid}.xml` | 弹幕数据 |
| `https://passport.bilibili.com/x/passport-login/web/qrcode/generate` | 获取登录二维码 |
| `https://passport.bilibili.com/x/passport-login/web/qrcode/poll` | 查询登录状态 |

## 数据格式

### 视频信息结构

```javascript
{
  aid: number,           // AV 号
  bvid: string,          // BV 号
  pid: number,           // 分 P 编号
  cid: number,           // 内容 ID
  videoData: {           // 视频元数据
    title: string,
    pic: string,
    // ... 其他字段
  },
  playUrl: {             // 播放地址
    dash: {
      video: [...],      // 视频流列表
      audio: [...]       // 音频流列表
    }
  }
}
```

### 弹幕数据结构

```javascript
{
  time: number,          // 弹幕时间（秒）
  sendTime: number,     // 发送时间（时间戳）
  user: string,         // 发送者
  text: string          // 弹幕内容
}
```

## 关键常量

```javascript
// User-Agent
USER_AGENT = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ..."

// 正则表达式
REGEX_PLAY_INFO = /<script>window\.__playinfo__=(.*?)<\/script>/
REGEX_INITIAL_STATE = /__INITIAL_STATE__=(.*?);\(function\(\)/

// 基础 URL
BILIBILI_URL = "https://www.bilibili.com"
```

## 存储位置

| 数据 | 位置 |
|------|------|
| 登录信息 | `app/js/login/login_info` |
| 下载文件 | 用户选择的目录（默认 Downloads） |

## 启动命令

```bash
npm install    # 安装依赖
npm start      # 启动应用
```

## 开发注意事项

1. **Electron 镜像**: 如果网络受限，需要设置 `ELECTRON_MIRROR` 环境变量
2. **Node.js 集成**: 渲染进程可以直接使用 Node.js API
3. **Cookie 管理**: 登录信息存储在本地，注意安全性
4. **断点续传**: 通过 HTTP Range 请求实现
5. **进度追踪**: 使用 progress-stream，更新频率 250ms

