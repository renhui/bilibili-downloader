# Bilibili 下载器项目架构分析

## 项目概述

**项目名称**: Mimi Downloader (mimi-downloader)  
**版本**: 1.9.0  
**许可证**: GPL-3.0-or-later  
**项目类型**: 基于 Electron 的桌面应用程序  
**主要功能**: Bilibili 视频、音频和弹幕下载工具

## 技术栈

### 核心技术
- **Electron 34.0.2**: 跨平台桌面应用框架
- **Node.js**: 后端运行时环境
- **Bootstrap 5.3.3**: UI 框架
- **jQuery 3.7.1**: DOM 操作和事件处理

### 核心依赖
- **ffmpeg-static 5.2.0**: FFmpeg 静态二进制文件
- **fluent-ffmpeg 2.1.3**: FFmpeg 的 Node.js 封装
- **node-fetch 2.0.0**: HTTP 请求库
- **tough-cookie 5.0.0**: Cookie 管理
- **qrcode 1.5.3**: 二维码生成
- **progress-stream 2.0.0**: 下载进度追踪
- **filenamify 4.0.0**: 文件名清理
- **mime 3.0.0**: MIME 类型处理

## 项目架构

### 整体架构模式
项目采用 **Electron 主进程 + 渲染进程** 架构：

```
┌─────────────────────────────────────┐
│      Electron 主进程 (main.js)      │
│  - 窗口管理                          │
│  - IPC 通信                          │
│  - 系统对话框                        │
└──────────────┬──────────────────────┘
               │ IPC
┌──────────────▼──────────────────────┐
│   渲染进程 (panel.html + JS)        │
│  - UI 界面                           │
│  - 业务逻辑                           │
│  - 用户交互                           │
└─────────────────────────────────────┘
```

### 目录结构

```
bilibili-downloader/
├── app/                          # 应用主目录
│   ├── main.js                  # Electron 主进程入口
│   ├── panel.html               # 主界面 HTML
│   ├── style.css                # 样式文件
│   ├── bg.png                   # 背景图片
│   ├── js/                      # JavaScript 模块
│   │   ├── panel.js             # 面板控制逻辑
│   │   ├── downloader.js        # 下载核心模块
│   │   ├── danmaku.js           # 弹幕处理模块
│   │   ├── merge.js             # 音视频合并模块
│   │   └── login/               # 登录模块
│   │       ├── login.js         # 登录服务主类
│   │       ├── login-qr.js      # 二维码登录
│   │       └── login-helper.js  # 登录辅助工具
│   └── cdn/                     # 第三方库
│       ├── ass.js               # ASS 字幕生成库
│       └── crc32.js             # CRC32 哈希计算
├── package.json                 # 项目配置
├── README.md                    # 项目说明
└── LICENSE                      # 许可证文件
```

## 核心功能模块

### 1. 主进程模块 (app/main.js)

**职责**:
- 创建和管理 Electron 窗口
- 处理 IPC 通信
- 系统对话框和菜单
- 文件系统操作

**关键功能**:
- `createPanel()`: 创建主窗口
- IPC 处理器:
  - `length`: 跟踪下载任务数量
  - `show-context-menu`: 右键菜单
  - `open-dialog`: 文件选择对话框
  - `open-path`: 打开文件路径
  - `show-message`: 显示消息框

### 2. 下载器核心模块 (app/js/downloader.js)

**类: Downloader**

**核心属性**:
- `aid`: 视频 AV 号
- `bvid`: 视频 BV 号
- `pid`: 分 P 编号
- `cid`: 视频内容 ID
- `videoData`: 视频元数据
- `playUrl`: 播放地址信息
- `items`: 可下载资源列表
- `tasks`: 下载任务列表

**核心方法**:
- `getPlayUrlWebPage(url)`: 从网页获取播放信息
  - 解析 `__INITIAL_STATE__` 获取视频信息
  - 解析 `__playinfo__` 获取播放地址
- `getDownloadItems()`: 解析可下载资源
  - 解析 DASH 格式的视频流
  - 解析音频流
- `downloadByIndex(part, file, callback)`: 下载指定资源
  - 支持断点续传
  - 进度回调
- `parseVideo()`: 解析视频流信息
- `parseAudio()`: 解析音频流信息

**辅助函数**:
- `requestWeb()`: HTTP 请求封装
  - 自动添加 Cookie
  - 重试机制
  - User-Agent 设置

### 3. 面板控制模块 (app/js/panel.js)

**类: Panel**

**核心方法**:
- `getVideoInfo()`: 获取视频信息
  - 调用下载器获取视频数据
  - 更新 UI 显示
  - 触发弹幕获取
- `getDownloadItems()`: 显示可下载资源列表
  - 生成表格显示视频/音频选项
- `downloadChecked()`: 下载选中的资源
  - 并行下载视频和音频
  - 显示下载进度
  - 完成后提示合并

### 4. 弹幕处理模块 (app/js/danmaku.js)

**核心功能**:
- `getDanmaku()`: 获取弹幕 XML
  - 从 Bilibili API 获取弹幕数据
  - 解析 XML 格式
- `danmakuFilter()`: 弹幕过滤
  - 关键词搜索
  - 时间范围过滤
  - 发送者过滤
- `xml()`: 下载 XML 格式弹幕
- `ass()`: 转换并下载 ASS 格式弹幕
  - 使用 `ass.js` 库转换格式
- `searchUser()`: 通过用户名查找用户
  - 使用 CRC32 破解用户 ID

### 5. 登录模块

#### 5.1 登录服务 (app/js/login/login.js)

**类: LoginService**

**核心流程**:
1. `login()`: 初始化登录流程
   - 获取登录二维码 URL
   - 生成二维码图片
   - 启动状态轮询
2. `getLoginStatus(oauthKey)`: 轮询登录状态
   - 状态码:
     - `86038`: 二维码过期
     - `86101`: 未扫码
     - `86090`: 已扫码未确认
     - `0`: 登录成功

#### 5.2 二维码登录 (app/js/login/login-qr.js)

**类: LoginQR (静态类)**

**方法**:
- `getLoginUrl()`: 获取登录二维码 URL
- `getLoginStatus(qrcodeKey)`: 查询登录状态
- `getLoginQRCodeFromUrl(url)`: 生成二维码图片

#### 5.3 登录辅助 (app/js/login/login-helper.js)

**类: LoginHelper (静态类)**

**方法**:
- `parseCookie(url)`: 解析登录返回的 Cookie
- `saveLoginInfoCookies(url)`: 保存登录信息到本地
- `getLoginInfoCookies()`: 读取本地登录信息

**存储位置**: `app/js/login/login_info`

### 6. 音视频合并模块 (app/js/merge.js)

**功能**: 使用 FFmpeg 合并视频和音频

**方法**:
- `ffmpegMerge(videoPath, audioPath, outputPath)`
  - 视频流直接复制 (`-c:v copy`)
  - 音频转码为 AAC (`-c:a aac`)

## 数据流和工作流程

### 视频下载流程

```
用户输入视频 URL
    ↓
Panel.getVideoInfo()
    ↓
Downloader.getPlayUrlWebPage()
    ↓
解析网页获取 __INITIAL_STATE__ 和 __playinfo__
    ↓
提取视频信息 (aid, bvid, cid, title)
    ↓
解析 DASH 流获取视频/音频地址
    ↓
显示可下载资源列表
    ↓
用户选择资源并点击下载
    ↓
Panel.downloadChecked()
    ↓
并行下载视频和音频
    ↓
显示下载进度
    ↓
下载完成，提示合并
    ↓
ffmpegMerge() 合并文件
```

### 登录流程

```
应用启动
    ↓
LoginService.login()
    ↓
获取登录二维码 URL
    ↓
生成二维码图片显示
    ↓
轮询登录状态 (每秒一次)
    ↓
用户扫码确认
    ↓
登录成功，保存 Cookie
    ↓
后续请求自动携带 Cookie
```

### 弹幕下载流程

```
获取视频信息后自动触发
    ↓
getDanmaku()
    ↓
从 comment.bilibili.com 获取 XML
    ↓
解析弹幕数据
    ↓
用户可选择:
    - 查看/过滤弹幕
    - 下载 XML 格式
    - 下载 ASS 格式 (需要转换)
```

## 关键技术实现

### 1. 视频信息获取

通过正则表达式从网页 HTML 中提取：
- `__INITIAL_STATE__`: 包含视频基本信息
- `__playinfo__`: 包含播放地址和流信息

### 2. 断点续传

```javascript
const state = fs.statSync(file);
headers: {
    "Range": `bytes=${state ? state.size : 0}-`
}
```

### 3. 下载进度追踪

使用 `progress-stream` 库：
- 每 250ms 更新一次进度
- 计算下载速度、剩余时间、百分比

### 4. Cookie 管理

使用 `tough-cookie` 库：
- 登录后保存 Cookie 到本地文件
- 后续请求自动携带 Cookie
- 支持 Cookie 过期处理

### 5. 文件名清理

使用 `filenamify` 清理文件名，避免特殊字符导致文件系统错误。

## 用户界面

### 主要界面元素

1. **登录区域**: 显示二维码，支持扫码登录
2. **视频链接输入**: 输入 Bilibili 视频 URL
3. **下载地址标签页**:
   - 显示可下载资源列表 (视频/音频)
   - 选择下载路径
   - 设置文件名
   - 下载按钮
4. **视频信息标签页**: 显示视频元数据
5. **弹幕查询标签页**:
   - 弹幕列表
   - 过滤功能
   - 下载选项

### UI 框架

- Bootstrap 5.3.3 提供响应式布局
- 自定义 CSS 样式
- jQuery 处理 DOM 操作

## 安全考虑

1. **Cookie 存储**: 登录信息存储在本地文件，未加密
2. **User-Agent**: 使用标准浏览器 User-Agent
3. **Referer**: 请求时设置正确的 Referer
4. **Electron 安全**: 
   - `nodeIntegration: true` (允许 Node.js API)
   - `contextIsolation: false` (上下文隔离关闭)

## 已知限制

1. **未登录限制**: 未登录时只能下载低清晰度视频
2. **登录状态检查**: 目前未实现登录状态验证
3. **错误处理**: 部分错误处理较为简单
4. **并发下载**: 仅支持单个视频的下载

## 依赖关系图

```
main.js
  └── panel.html
      ├── panel.js
      │   ├── downloader.js
      │   │   ├── login-helper.js
      │   │   └── node-fetch
      │   ├── merge.js
      │   │   └── fluent-ffmpeg
      │   └── danmaku.js
      │       ├── ass.js (cdn)
      │       └── crc32.js (cdn)
      └── login.js
          ├── login-qr.js
          │   └── qrcode
          └── login-helper.js
```

## 扩展建议

1. **多任务下载**: 支持同时下载多个视频
2. **下载队列**: 实现下载任务队列管理
3. **登录状态验证**: 定期检查 Cookie 有效性
4. **配置管理**: 添加用户配置保存功能
5. **下载历史**: 记录下载历史
6. **批量下载**: 支持播放列表批量下载
7. **代理支持**: 添加代理配置选项

## 总结

这是一个结构清晰的 Electron 桌面应用，采用模块化设计，主要功能包括：
- 视频信息获取和解析
- 视频/音频下载（支持断点续传）
- 弹幕获取和转换
- 二维码登录
- 音视频合并

代码组织良好，各模块职责明确，易于维护和扩展。

